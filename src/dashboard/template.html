<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#000000">
	<title>sheltupdate r{VERSION}</title>

	<script type="importmap"> { "imports": {
		"@unocss/": "https://esm.sh/@unocss/",
		"@observablehq/": "https://esm.sh/@observablehq/",
		"date-fns/": "https://esm.sh/date-fns/"
	} }</script>

	<script type="module">
		import presetUno from "@unocss/preset-uno";
		import presetWebFonts from "@unocss/preset-web-fonts";
		import presetAttributify from "@unocss/preset-attributify";
		import transformerDirectives from "@unocss/transformer-directives";
		import initUno from "@unocss/runtime";

		initUno({defaults: {
			presets: [presetUno(), presetAttributify(), presetWebFonts({
				// lol what
				customFetch: (url) => fetch(url).then(r => r.text()),
				fonts: {
					sans: [{name: "IBM Plex Sans", weights: [400, 700], italic: true}],
					mono: [{name: "IBM Plex Mono", weights: [400, 700], italic: true}],
				}
			})],
			transformers: [transformerDirectives()]
		}});
	</script>

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@unocss/reset/normalize.min.css">
</head>

<body m="0" p="4" bg="black" text="white" font="mono">
	<div flex="~ items-baseline justify-between" b-b="px white solid" mb="4" pb="2">
		<h1 m="0">sheltupdate r{VERSION}</h1>

		<a text="white lg" decoration="none" border="px solid white" px="2" float="right"
			href="https://shelter.uwu.network/install"
		>
			Install
		</a>
	</div>

	<p italic>Statistics are not live, even though relative times update.</p>

	<div flex="~ wrap" gap="3" mb="3">

		<div class="stats-card basic">
			<h2>Server Uptime</h2>
			<p text="2xl" id="stat-uptime"></p>
			<p class="sub">Up since <span id="stat-start-time"></span> (local time)</p>
		</div>

		<div class="stats-card basic">
			<h2>Last Module Download</h2>
			<p text="2xl" id="stat-last-mod">15 minutes</p>
		</div>

		<div class="stats-card basic">
			<h2>Unique Users</h2>
			<p text="2xl">{USER_COUNT}</p>
			<p class="sub">Users are 100% anonymised</p>
		</div>
	</div>

	<div flex gap="3">
		<div flex="~ col basis-3/5" gap="3">
			<div class="stats-card">
				<h2>Endpoint Hit Counts</h2>
				<div id="endpoint-plot-wrap" class="children:text-sm!"></div>
			</div>

			<div class="stats-card">
				<h2>Branches</h2>
				<div id="branches-wrap" class="children:text-sm!"></div>
			</div>
		</div>

		<div class="stats-card" flex="basis-2/5">
			<h2>Proportions</h2>
			<div id="plats-wrap" class="children:text-sm!"></div>
			<div id="chans-wrap" class="children:text-sm!"></div>
			<div id="hosts-wrap" class="children:text-sm!"></div>
			<div id="apiv-wrap" class="children:text-sm!"></div>
		</div>
	</div>

	<script type="module">
		// for some reason esm.sh needs bundle-deps for this.
		// oh well, plot is huge so this probably helps a lot.
		import * as Plot from "@observablehq/plot?bundle-deps";
		import {format, formatDuration, intervalToDuration} from "date-fns/?exports=format,formatDuration,intervalToDuration";

		const since = (t) => intervalToDuration({ start: t, end: new Date() });

		const cap = (s) => s.split(" ").map(w => w[0].toUpperCase() + w.slice(1)).join(" ");

		const [
			uptimeEl,
			startTimeEl,
			lastModEl,
			endpointWrap,
			branchesWrap,
			channelsWrap,
			platformsWrap,
			hostVersWrap,
			apiVersWrap,
		] = [
			"stat-uptime",
			"stat-start-time",
			"stat-last-mod",
			"endpoint-plot-wrap",
			"branches-wrap",
			"chans-wrap",
			"plats-wrap",
			"hosts-wrap",
			"apiv-wrap"
		].map(document.getElementById.bind(document));

		const statsState = {STATE} /*{
			uniqueUsers: {
				a: {
					platform: "linux",
					host_version: "0.0.78",
					channel: "stable",
					branch: "shelter+reactdevtools+vencord",
					apiVer: 1,
					time: new Date("2024-12-20 9:00:00")
				},
				b: {
					platform: "win",
					host_version: "unknown",
					channel: "canary",
					branch: "shelter+vencord",
					apiVer: 2,
					time: new Date("2024-12-20 16:00:00")
				},
				c: {
					platform: "win",
					host_version: "unknown",
					channel: "canary",
					branch: "shelter+vencord",
					apiVer: 2,
					time: new Date("2024-12-20 16:00:00")
				},
				d: {
					platform: "mac",
					host_version: "unknown",
					channel: "stable",
					branch: "vencord",
					apiVer: 2,
					time: new Date("2024-12-20 13:00:00")
				}
			},
			requestCounts: {
				v1_host_squirrel: 435,
				v1_host_notsquirrel: 34,
				v1_modules: 45,
				v1_module_download: 345,
				v2_manifest: 45,
				v2_module: 56,
				v2_custom_module: 3,
			},
			proxyOrRedirect: {
				proxied: 0,
				redirected: 0,
			},
			proxyCacheHitRatio: {
				hit: 0,
				miss: 0,
			},
			v1ModuleCacheHitRatio: {
				hit: 0,
				miss: 0,
			},
			v2ManifestCacheHitRatio: {
				hit: 0,
				miss: 0,
			}
		};*/

		const userTimes = Object.values(statsState.uniqueUsers).map(u => u.time);
		const lastUserTime = userTimes.reduce((a, b) => Math.max(a, b), 0); // who needs quickselect?

		const startTime = new Date({START_TIME} /*1734667290000*/);
		startTimeEl.textContent = format(startTime, "h:mm:ss b");

		const refreshTimes = () => {
			uptimeEl.textContent = formatDuration(since(startTime), { format: ["days", "hours", "minutes"]});

			if (lastUserTime)
				lastModEl.textContent = formatDuration(since(lastUserTime), { format: ["hours", "minutes"] });
		};
		refreshTimes();
		setInterval(refreshTimes, 20_000);

		const endpointsEntries = Object.entries(statsState.requestCounts)
			.map(([name, hits]) => {
				const ns = name.split("_");

				return { hits, endpoint: cap(ns.slice(1).join(" ")) + ` [${ns[0].toUpperCase()}]` };
			});

		const branchCounts = {};
		const platformCounts = {};
		const hostVerCounts = {};
		const apiVerCounts = {};
		const channelCounts = {};
		for (const user of Object.values(statsState.uniqueUsers)) {
			const host = user.host_version === "unknown" ? "Unknown Host" : "Host " + user.host_version;

			for (const br of user.branch.split("+")) {
				branchCounts[cap(br)] ??= 0;
				branchCounts[cap(br)]++;
			}
			platformCounts[cap(user.platform)] ??= 0;
			platformCounts[cap(user.platform)]++;
			hostVerCounts[host] ??= 0;
			hostVerCounts[host]++;
			apiVerCounts["API V" + user.apiVer] ??= 0;
			apiVerCounts["API V" + user.apiVer]++;
			channelCounts[cap(user.channel)] ??= 0;
			channelCounts[cap(user.channel)]++;
		}

		endpointWrap.append(
			Plot.plot({
				marginTop: 0,
				marginLeft: 160,
				marginRight: 35,
				label: null,
				marks: [
					Plot.barX(endpointsEntries, { y: "endpoint", x: "hits", sort: {y: "-x"} }),
					Plot.text(endpointsEntries, { y: "endpoint", x: "hits", text: "hits", textAnchor: "start", dx: 3}),
					Plot.gridX()
				]
			})
		);

		branchesWrap.append(
			Plot.plot({
				marginTop: 0,
				marginLeft: 120,
				marginRight: 35,
				label: null,
				marks: [
					Plot.barX(Object.entries(branchCounts), { y: "0", x: "1", sort: {y: "-x"} }),
					Plot.text(Object.entries(branchCounts), { y: "0", x: "1", text: "1", textAnchor: "start", dx: 3 }),
					Plot.gridX()
				]
			})
		);

		platformsWrap.append(
			Plot.plot({
				marginTop: 0,
				marginLeft: 35,
				marginRight: 35,
				label: null,
				axis: false,
				color: {legend: true, scheme: "dark2"},
				marks: [
					Plot.barX(Object.entries(platformCounts), { x: "1", fill: "0" }),
					Plot.gridX()
				]
			})
		);

		channelsWrap.append(
			Plot.plot({
				marginTop: 0,
				marginLeft: 35,
				marginRight: 35,
				label: null,
				axis: false,
				color: {legend: true, scheme: "dark2"},
				marks: [
					Plot.barX(Object.entries(channelCounts), { x: "1", fill: "0" }),
					Plot.gridX()
				]
			})
		);

		hostVersWrap.append(
			Plot.plot({
				marginTop: 0,
				marginLeft: 35,
				marginRight: 35,
				label: null,
				axis: false,
				color: {legend: true, scheme: "dark2"},
				marks: [
					Plot.barX(Object.entries(hostVerCounts), { x: "1", fill: "0" }),
					Plot.gridX()
				]
			})
		);

		apiVersWrap.append(
			Plot.plot({
				marginTop: 0,
				marginLeft: 35,
				marginRight: 35,
				label: null,
				axis: false,
				color: {legend: true, scheme: "dark2"},
				marks: [
					Plot.barX(Object.entries(apiVerCounts), { x: "1", fill: "0" }),
					Plot.gridX()
				]
			})
		);
	</script>

<style>
	.stats-card {
		border: 1px solid white;
		padding: .5rem;
		display: grid;
		align-items: baseline;
		column-gap: 2rem;
		row-gap: 0.25rem;
		flex-grow: 1;
	}

	.stats-card:not(.basic) > div {
		justify-self: center;
	}

	.stats-card > * { margin: 0; }

	.stats-card.basic {
		grid-template-columns: 1fr auto;
	}
	.stats-card.basic > .sub {
		grid-column-end: span 2;
		font-style: italic;
	}
</style>
</body>
</html>